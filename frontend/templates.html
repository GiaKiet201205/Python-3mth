<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptimoRoute - Route Optimizer</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="templates.css" />
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav ">
        <div class="nav-brand">
            <i class="fas fa-route"></i>
            KMKC
        </div>

        <div class="nav-right">
            <div class="nav-buttons">
                <button class="nav-btn" onclick="showAddCustomerModal()">
                <i class="fas fa-user-plus"></i> Add Customer
            </button>
                <button class="nav-btn">
                    <i class="fas fa-play"></i> Get started
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="planning-section">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt"></i> Plan and Optimize
                    </h5>
                </div>


                <div class="action-buttons">
                    <button class="btn-primary" onclick="optimizeRoutes()">
                        <i class="fas fa-magic"></i> Optimize
                    </button>
                    <button class="btn-outline" onclick="switchView()">
                        <i class="fas fa-exchange-alt"></i> Switch
                    </button>
                    <button class="btn-outline" onclick="copyRoutes()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
            </div>

            <div class="drivers-section">
                <h6 class="mb-3 px-2">
                    <i class="fas fa-truck"></i> Driver
                    <span id="driver-count-badge" class="badge bg-primary rounded-pill ms-2"> 0 drivers selected </span>
                </h6>

                <div id="driver-list-container">
                    <p style="padding: 1rem; color: var(--secondary-color);">Đang tải danh sách tài xế...</p>

                </div>
            </div>

            <div class="p-3 border-top">
                <button class="btn-outline w-100" onclick="hideDrivers()">
                    <i class="fas fa-eye-slash"></i> Hide Drivers
                </button>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>

            <!-- Map Controls -->
            <div class="map-controls">
                <button class="control-btn" onclick="centerMap()" title="Center Map">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="control-btn" onclick="zoomIn()" title="Zoom In">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="control-btn" onclick="zoomOut()" title="Zoom Out">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="control-btn" onclick="toggleSatellite()" title="Satellite View">
                    <i class="fas fa-satellite"></i>
                </button>
                <button class="control-btn" onclick="toggleTraffic()" title="Traffic">
                    <i class="fas fa-car"></i>
                </button>
                <button class="control-btn" onclick="exportMap()" title="Export">
                    <i class="fas fa-download"></i>
                </button>
                <button class="control-btn" onclick="fullScreen()" title="Full Screen">
                    <i class="fas fa-expand"></i>
                </button>
            </div>

            <!-- Bottom Panel -->
            <div class="bottom-panel border-top bg-light">
                  <div class="d-flex justify-content-between align-items-center p-2">

                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="panelTabs">
                      <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="switchTab(this, 'orders')">
                          <i class="fas fa-list"></i> Orders
                        </a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchTab(this, 'routes')">
                          <i class="fas fa-route"></i> Routes
                        </a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchTab(this, 'timeline')">
                          <i class="fas fa-clock"></i> Timeline
                        </a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchTab(this, 'not-scheduled')">
                          <i class="fas fa-exclamation-triangle"></i> Not Scheduled
                        </a>
                      </li>
                    </ul>


                    <div class="d-flex align-items-center">
                          <button class="btn btn-primary btn-sm me-2" onclick="importOrders()">
                            <i class="fas fa-upload"></i> Import Orders
                          </button>
                          <button class="btn btn-success btn-sm me-2" onclick="optimizeRoutes()">
                            <i class="fas fa-route"></i> Plan Routes
                          </button>
                          <button class="btn btn-outline-secondary btn-sm" onclick="shareRoutes()">
                            <i class="fas fa-share"></i> Share Routes
                          </button>
                          <button class="btn btn-link ms-2" onclick="toggleBottomPanel()" title="Toggle Panel">
                            <i class="fas fa-chevron-down"></i>
                          </button>
                    </div>
                </div>

                <div id="panel-content-container" class="panel-content">
                </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Routes have been planned</span>
        <button onclick="hideNotification()" style="background: none; border: none; color: white; margin-left: 1rem;">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Optimizing routes...</div>
    </div>



    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SheetJS for Excel processing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Custom functions -->
    <script src="../backend/func.js"></script>

    <script>
        // Initialize map
        let map;
        let markers = [];
        let routes = [];
        let currentTab = 'orders';

        let allDrivers = [];
        let allCustomers = [];
        let allDepots = [];

        // Sample orders data
        const ordersData = [];

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            initMap();
            await loadAllData();
            // populateOrdersTable();
            loadAndDisplayDrivers();
            loadAndDisplayCustomers();

            switchTab(document.querySelector('.nav-link.active'), 'orders'); // Hiển thị tab Orders mặc định

            showNotification('Dữ liệu đã được tải. Sẵn sàng tối ưu!');

            // Khởi tạo các event listeners cho Add Customer
            initAddCustomerEvents();
        });

        async function loadAllData() {
            try {
                // Gửi 3 yêu cầu cùng lúc và chờ tất cả hoàn thành
                const [driversRes, customersRes, depotsRes] = await Promise.all([
                    fetch('../data/drivers.json'),
                    fetch('../data/customers.json'),
                    fetch('../data/depots.json')
                ]);

                // Chuyển đổi kết quả thành JSON
                allDrivers = await driversRes.json();
                allCustomers = await customersRes.json();
                allDepots = await depotsRes.json();

                console.log("Tất cả dữ liệu đã được tải thành công!");

            } catch (error) {
                console.error("Lỗi nghiêm trọng khi tải dữ liệu ban đầu:", error);
                // Có thể hiển thị một thông báo lỗi lớn ở đây
            }
        }

        function initMap() {
            try {
                // Initialize Leaflet map centered on Ho Chi Minh City
                map = L.map('map').setView([10.8231, 106.6297], 12);

                // Đảm bảo window.map được gán đúng instance và có các phương thức cần thiết
                window.map = map;

                // Đợi map sẵn sàng hoàn toàn trước khi sử dụng
                setTimeout(() => {
                    if (window.map && typeof window.map.addLayer === 'function') {
                        console.log('✅ Map đã sẵn sàng với đầy đủ chức năng');
                    } else {
                        console.error('❌ Map chưa sẵn sàng sau khi khởi tạo');
                    }
                }, 100);

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | <a href="https://www.mapbox.com/">MapBox Streets</a>'
                }).addTo(map);

                const depotIcon = L.icon({
                  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41],
                  popupAnchor: [1, -34],
                  shadowSize: [41, 41]
                });

                // 2️⃣ Tạo icon riêng cho customer (màu đỏ)
                const customerIcon = L.icon({
                  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41],
                  popupAnchor: [1, -34],
                  shadowSize: [41, 41]
                });

                // 3️⃣ Load depot markers (màu xanh)
                fetch("../data/depots.json")
                  .then(response => response.json())
                  .then(data => {
                    data.forEach(depot => {
                      const marker = L.marker([depot.latitude, depot.longitude], { icon: depotIcon }).addTo(map);
                      marker.bindPopup(`<b>${depot.name}</b><br>Lat: ${depot.latitude}<br>Lon: ${depot.longitude}`);
                    });
                  })
                  .catch(error => console.error("Lỗi tải JSON depot:", error));

                // 4️⃣ Load customer markers (màu đỏ)
                fetch("../data/customers.json")
                  .then(response => response.json())
                  .then(data => {
                    data.forEach(customer => {
                      if (customer.latitude && customer.longitude) {
                        const marker = L.marker([customer.latitude, customer.longitude], { icon: customerIcon }).addTo(map);
                        marker.bindPopup(`<b>${customer.name}</b><br>ID: ${customer.id}<br>Địa chỉ: ${customer.address}<br>SĐT: ${customer.phone}`);
                      }
                    });
                  })
                  .catch(error => console.error("Lỗi tải JSON customer:", error));

                console.log('Map đã được khởi tạo thành công:', map);

            } catch (error) {
                console.error('Lỗi khi khởi tạo map:', error);
            }
        }

        // Toggle bottom panel
        function toggleBottomPanel() {
            const panel = document.querySelector('.bottom-panel');
            panel.classList.toggle('collapsed');
        }

        // Tab switching
        function switchTab(tabElement, tabName) {
            document.querySelectorAll('.panel-tab, .nav-link').forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');
            currentTab = tabName;

            // Dựa vào tab được chọn, gọi hàm tương ứng để vẽ lại nội dung
            if (tabName === 'orders') {
                populateOrdersTable();
            } else if (tabName === 'routes') {
                populateRoutesTable(); // Gọi hàm mới của chúng ta
            } else {
                // Các tab khác tạm thời hiển thị thông báo
                const panelContent = document.getElementById('panel-content-container');
                panelContent.innerHTML = `<div style="text-align: center; padding: 2rem; color: #6b7280;">Chức năng ${tabName} đang được phát triển.</div>`;
            }
        }

        function populateOrdersTable() {
            const panelContent = document.getElementById('panel-content-container');
            let tableHTML = `
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" onchange="selectAllOrders(this)"></th>
                            <th>Customer ID</th>
                            <th>Tên Khách Hàng</th>
                            <th>Địa Chỉ</th>
                            <th>Số Điện Thoại</th>
                            <th>Email</th>
                            <th>Tọa Độ (Lat, Lon)</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody">
            `;

            allCustomers.forEach(customer => {
                tableHTML += `
                    <tr>
                        <td><input type="checkbox" class="order-checkbox"></td>
                        <td><strong>${customer.id}</strong></td>
                        <td>${customer.name}</td>
                        <td>${customer.address}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.latitude || 0}, ${customer.longitude || 0}</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            panelContent.innerHTML = tableHTML;
        }

        function populateRoutesTable() {
            const panelContent = document.getElementById('panel-content-container');

            // 1. Tạo HTML cho sườn bảng và tiêu đề cột
            let tableHTML = `
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Driver ID</th>
                            <th>Tên Tài Xế</th>
                            <th>Kho Xuất Phát (ID)</th>
                            <th>Địa Chỉ Kho</th>
                            <th>Customer ID</th>
                            <th>Điểm Đến (Khách Hàng)</th>
                            <th>Tuyến Đường (Tạm thời)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // 2. Bắt cặp ngẫu nhiên (tạm thời)
            // Lấy một danh sách khách hàng đã được xáo trộn
            const shuffledCustomers = [...allCustomers].sort(() => 0.5 - Math.random());

            // 3. Lặp qua từng tài xế để tạo một hàng trong bảng
            allDrivers.forEach((driver, index) => {
                // Bắt cặp tài xế với một khách hàng ngẫu nhiên
                const customer = shuffledCustomers[index % shuffledCustomers.length];

                // Tìm thông tin kho của tài xế dựa trên depot_id
                const depot = allDepots.find(d => d.id === driver.depot_id);
                const depotAddress = depot ? depot.address : "Không tìm thấy kho";

                // 4. Tạo HTML cho hàng dữ liệu
                tableHTML += `
                    <tr>
                        <td><strong>${driver.id}</strong></td>
                        <td>${driver.name}</td>
                        <td>Kho ${driver.depot_id}</td>
                        <td>${depotAddress}</td>
                        <td><strong>${customer.id}</strong></td>
                        <td>${customer.address}</td>
                        <td><em>null</em></td>
                    </tr>
                `;
            });

            // 5. Đóng bảng và gán vào giao diện
            tableHTML += `</tbody></table>`;
            panelContent.innerHTML = tableHTML;
        }

        function updatePanelContent(tabName) {
            const tbody = document.getElementById('orders-tbody');

            if (tabName === 'orders') {
                populateOrdersTable();
            } else if (tabName === 'routes') {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4">Routes information will be displayed here</td></tr>';
            } else if (tabName === 'timeline') {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4">Timeline view will be displayed here</td></tr>';
            } else if (tabName === 'not-scheduled') {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4">Unscheduled orders will be displayed here</td></tr>';
            }
        }

        async function loadAndDisplayCustomers() {
            const tbody = document.getElementById('orders-tbody');
            if (!tbody) {
                console.error("Lỗi: Không tìm thấy tbody với id='orders-tbody'");
                return;
            }

            try {
                // Đảm bảo đường dẫn này chính xác (cùng cấp với đường dẫn depots.json)
                const response = await fetch('../data/customers.json');
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP: ${response.status}`);
                }
                const customers = await response.json();

                // Xóa dòng "Đang tải..."
                tbody.innerHTML = '';

                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 1rem;">Không có dữ liệu khách hàng.</td></tr>';
                    return;
                }

                // Lặp qua từng khách hàng và tạo một hàng (tr) mới
                customers.forEach(customer => {
                    const row = document.createElement('tr');

                    // Tạo nội dung HTML cho các ô (td)
                    row.innerHTML = `
                        <td><input type="checkbox" class="order-checkbox" value="${customer.id}"></td>
                        <td><strong>${customer.id}</strong></td>
                        <td>${customer.name}</td>
                        <td>${customer.address}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.latitude || 0}, ${customer.longitude || 0}</td>
                    `;

                    // Thêm hàng mới tạo vào trong tbody
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error("Lỗi không thể tải file customers.json:", error);
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 1rem; color: red;">Không thể tải dữ liệu khách hàng.</td></tr>`;
            }
        }

        // Driver functions
        function toggleDriver(element, driverId) {
            // 1. Lấy checkbox bên trong
            const checkbox = element.querySelector('.driver-checkbox');

            // 2. Khi click vào div, chúng ta sẽ "đảo" trạng thái của class 'selected'
            element.classList.toggle('selected');

            // 3. Đồng bộ trạng thái của checkbox VỚI trạng thái 'selected' của div
            // Đây là logic đúng: gán trạng thái, không phải "đảo ngược"
            checkbox.checked = element.classList.contains('selected');

            // 4. Gọi hàm đếm số lượng tài xế đã chọn
            updateSelectedDriversCount();
        }

        function updateSelectedDriversCount() {
            const selectedCount = document.querySelectorAll('.driver-checkbox:checked').length;
            const badge = document.querySelector('.badge');
            if (badge) {
                badge.textContent = `${selectedCount} drivers selected`;
            }
        }

        // Map functions
        function centerMap() {
            map.setView([10.8231, 106.6297], 12);
        }

        function zoomIn() {
            map.zoomIn();
        }

        function zoomOut() {
            map.zoomOut();
        }

        function toggleSatellite() {
            // Toggle between normal and satellite view
            const currentLayer = map._layers[Object.keys(map._layers)[0]];
            map.removeLayer(currentLayer);

            if (currentLayer._url.includes('openstreetmap')) {
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles © Esri'
                }).addTo(map);
            } else {
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            }
        }

        function toggleTraffic() {
            showNotification('Traffic layer toggled');
        }

        function exportMap() {
            showNotification('Map exported successfully');
        }

        function fullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        async function optimizeRoutes() {
          showLoading();
          try {
            const response = await fetch("http://127.0.0.1:8000/api/calculate/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                num_vehicles_per_depot: 2
              })
            });

            const result = await response.json();
            hideLoading();

            if (result.status === "success") {
              showNotification("Routes optimized successfully!", "success");
              console.log("Kết quả:", result);
              // Có thể render routes lên map ở đây
            } else {
              showNotification(result.message || "No solution found!", "error");
            }

          } catch (error) {
            hideLoading();
            console.error("Error:", error);
            showNotification("Error while optimizing routes!", "error");
          }
        }

        function switchView() {
            // Lấy danh sách drivers được chọn
            const selectedDrivers = document.querySelectorAll('#driver-list-container .driver-checkbox:checked');
            if (selectedDrivers.length !== 2) {
                showNotification('Vui lòng chọn đúng 2 drivers để thực hiện switch!', 'error');
                return;
            }

            const driverItems = [];
            selectedDrivers.forEach(checkbox => {
                const driverItem = checkbox.closest('.driver-item');
                const driverId = checkbox.id.replace('checkbox-', '');
                const driverName = driverItem.querySelector('.driver-name').textContent;
                const depotInfo = driverItem.querySelector('.driver-contact-info span:last-child').textContent;
                const depotId = depotInfo.replace('Kho: ', '');

                driverItems.push({
                    id: driverId,
                    name: driverName,
                    depotId: depotId
                });
            });

            switchDriversDepot(driverItems[0].id, driverItems[1].id);
        }
        async function switchDriversDepot(driverId1, driverId2) {
            showLoading();
            try {
                const response = await fetch("http://127.0.0.1:8000/api/switch-drivers/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        driver_id_1: driverId1,
                        driver_id_2: driverId2
                    })
                });

                const result = await response.json();
                hideLoading();

                if (result.status === "success") {
                    showNotification(`Đã hoán đổi depot thành công! Driver ${driverId1} ↔ Driver ${driverId2}`, "success");
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification(result.message || "Không thể thực hiện switch!", "error");
                }

            } catch (error) {
                hideLoading();
                console.error("Error:", error);
                showNotification("Lỗi kết nối đến server!", "error");
            }
        }

        function reverseRoutes() {
            showNotification('Routes reversed');
        }

        async function copyRoutes() {
            const selectedDrivers = document.querySelectorAll('#driver-list-container .driver-checkbox:checked');
            if (selectedDrivers.length === 0) {
                showNotification('Vui lòng chọn ít nhất 1 driver để copy!', 'error');
                return;
            }

            try {
                const routesData = [];
                selectedDrivers.forEach(checkbox => {
                    const driverItem = checkbox.closest('.driver-item');
                    const driverId = checkbox.id.replace('checkbox-', '');
                    const driverName = driverItem.querySelector('.driver-name').textContent;
                    const depotInfo = driverItem.querySelector('.driver-contact-info span:last-child').textContent;
                    const depotId = depotInfo.replace('Kho: ', '');

                    // Tìm thông tin driver từ allDrivers array
                    const driverData = allDrivers.find(d => d.id === driverId);
                    const depotData = allDepots.find(d => d.id === depotId);

                    routesData.push({
                        driverId: driverId,
                        driverName: driverName,
                        depotId: depotId,
                        depotAddress: depotData ? depotData.address : 'Không tìm thấy địa chỉ',
                        phone: driverData ? driverData.phone : 'N/A'
                    });
                });
                let copyText = `=== DANH SÁCH TUYẾN ĐƯỜNG (${routesData.length} DRIVERS) ===\n`;
                copyText += `Thời gian xuất: ${new Date().toLocaleString('vi-VN')}\n\n`;

                routesData.forEach((route, index) => {
                    copyText += `${index + 1}. DRIVER ${route.driverId}\n`;
                    copyText += `   Tên: ${route.driverName}\n`;
                    copyText += `   SĐT: ${route.phone}\n`;
                    copyText += `   Kho xuất phát: ${route.depotId}\n`;
                    copyText += `   Địa chỉ kho: ${route.depotAddress}\n`;
                    copyText += `   Trạng thái: Unassigned\n`;
                    copyText += `   Tuyến đường: Chưa có dữ liệu tuyến đường cụ thể\n\n`;
                });

                copyText += `=== TỔNG KẾT ===\n`;
                copyText += `Tổng số drivers: ${routesData.length}\n`;
                copyText += `Đã copy lúc: ${new Date().toLocaleString('vi-VN')}\n`;

                // Copy vào clipboard
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(copyText);
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = copyText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();

                    try {
                        document.execCommand('copy');
                    } catch (err) {
                        console.error('Fallback: Không thể copy', err);
                        showNotification('Không thể copy vào clipboard!', 'error');
                        return;
                    }

                    textArea.remove();
                }
                showNotification(`Đã copy tuyến đường của ${routesData.length} drivers vào clipboard!`, 'success');
            } catch (error) {
                console.error('Lỗi khi copy routes:', error);
                showNotification('Có lỗi xảy ra khi copy!', 'error');
            }
        }

        function hideDrivers() {
            const driversSection = document.querySelector('.drivers-section');
            driversSection.style.display = driversSection.style.display === 'none' ? 'block' : 'none';
        }

        function importOrders() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Kiểm tra định dạng file
                    if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                        showNotification('Chỉ chấp nhận file Excel (.xlsx hoặc .xls)!', 'error');
                        return;
                    }

                    showNotification(`Đang xử lý file ${file.name}...`);
                    setTimeout(() => {
                        showNotification('Orders imported successfully!', 'success');
                    }, 2000);
                }
            };
            input.click();
        }

        function planRoutes() {
            showLoading();

            setTimeout(() => {
                hideLoading();
                showNotification('Routes planned successfully!', 'success');
            }, 2500);
        }

        function shareRoutes() {
            if (navigator.share) {
                navigator.share({
                    title: 'Route Optimization Results',
                    text: 'Check out these optimized routes!',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                showNotification('Link copied to clipboard!');
            }
        }

        function selectAllOrders(checkbox) {
            const orderCheckboxes = document.querySelectorAll('.order-checkbox');
            orderCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function viewOrderDetails(orderIndex) {
            const order = ordersData[orderIndex];
            alert(`Order Details:\n\nID: ${order.id}\nLocation: ${order.location}\nAddress: ${order.address}\nPriority: ${order.priority}\nWeight: ${order.weight}kg\nVolume: ${order.volume}m³\nDuration: ${order.duration}`);
        }

        function showNotification(message, type = 'default') {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notification-text');

            text.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'flex';

            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            document.getElementById('notification').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        async function loadAndDisplayDrivers() {
            const driverListContainer = document.getElementById('driver-list-container');

            if (!driverListContainer) {
                console.error("Lỗi: Không tìm thấy thẻ div với id='driver-list-container'.");
                return;
            }

            try {
                const response = await fetch('/data/drivers.json');
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP: ${response.status}`);
                }
                const drivers = await response.json();
                driverListContainer.innerHTML = '';

                if (drivers.length === 0) {
                    driverListContainer.innerHTML = '<p style="color: #6b7280; padding: 0.75rem;">Không có dữ liệu tài xế.</p>';
                    return;
                }
                const colors = ['#ef4444', '#f97316', '#22c55e', '#0bd2f5', '#6b7280'];
                drivers.forEach((driver, index) => {
                    // Validate dữ liệu driver
                    if (!driver.id || !driver.name || !driver.phone || !driver.depot_id) {
                        console.warn(`Dữ liệu driver không đầy đủ:`, driver);
                        return;
                    }
                    const color = colors[index % colors.length];
                    const driverItem = document.createElement('div');
                    driverItem.className = 'driver-item';
                    driverItem.id = `driver-${driver.id}`;
                    driverItem.onclick = function() {
                        toggleDriver(driverItem, driver.id);
                    };

                    driverItem.innerHTML = `
                        <input type="checkbox" class="driver-checkbox" id="checkbox-${driver.id}">
                        <div class="driver-color" style="background-color: ${color};"></div>
                        <div class="driver-info">
                            <div class="driver-name">${driver.name} (ID: ${driver.id})</div>
                            <div class="driver-contact-info">
                                <span><i class="fas fa-phone-alt"></i> ${driver.phone}</span>
                                <span><i class="fas fa-warehouse"></i> Kho: ${driver.depot_id}</span>
                            </div>
                            <div class="driver-stats">
                                <span class="text-muted">Unassigned</span>
                            </div>
                        </div>
                    `;
                    driverListContainer.appendChild(driverItem);
                });

                console.log(`Đã tải thành công ${drivers.length} tài xế`);

            } catch (error) {
                console.error("Lỗi không thể tải file drivers.json:", error);
                driverListContainer.innerHTML = '<p style="color: red; padding: 0.75rem;">Không thể tải danh sách tài xế.</p>';
            }
        }

        function updateSelectedDriversCount() {
            const selectedCount = document.querySelectorAll('#driver-list-container .driver-checkbox:checked').length;
            const driverCountBadge = document.getElementById('driver-count-badge');
            if (driverCountBadge) {
                driverCountBadge.textContent = `${selectedCount} drivers selected`;
            }
        }
        window.addEventListener('resize', function() {
            if (map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        });
    </script>
</body>
</html>
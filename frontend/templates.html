<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptimoRoute - Route Optimizer</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="templates.css" />
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav ">
        <div class="nav-brand">
            <i class="fas fa-route"></i>
            KMKC
        </div>

        <div class="nav-right">
            <div class="nav-buttons">
                <button class="nav-btn" onclick="showAddCustomerModal()">
                <i class="fas fa-user-plus"></i> Add Customer
            </button>
                <button class="nav-btn">
                    <i class="fas fa-play"></i> Get started
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="planning-section">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt"></i> Plan and Optimize
                    </h5>
                </div>


                <div class="action-buttons">
                    <button class="btn-primary" onclick="optimizeRoutes()">
                        <i class="fas fa-magic"></i> Optimize
                    </button>
                    <button class="btn-outline" onclick="switchView()">
                        <i class="fas fa-exchange-alt"></i> Switch
                    </button>
                    <button class="btn-outline" onclick="copyRoutes()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
            </div>

            <div class="drivers-section">
                <h6 class="mb-3 px-2">
                    <i class="fas fa-truck"></i> Driver
                    <span id="driver-count-badge" class="badge bg-primary rounded-pill ms-2"> 0 drivers selected </span>
                </h6>

                <div id="driver-list-container">
                    <p style="padding: 1rem; color: var(--secondary-color);">ƒêang t·∫£i danh s√°ch t√†i x·∫ø...</p>

                </div>
            </div>

            <div class="p-3 border-top">
                <button class="btn-outline w-100" onclick="hideDrivers()">
                    <i class="fas fa-eye-slash"></i> Hide Drivers
                </button>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>

            <!-- Map Controls -->
            <div class="map-controls">
                <button class="control-btn" onclick="centerMap()" title="Center Map">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="control-btn" onclick="zoomIn()" title="Zoom In">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="control-btn" onclick="zoomOut()" title="Zoom Out">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="control-btn" onclick="toggleSatellite()" title="Satellite View">
                    <i class="fas fa-satellite"></i>
                </button>
                <button class="control-btn" onclick="toggleTraffic()" title="Traffic">
                    <i class="fas fa-car"></i>
                </button>
                <button class="control-btn" onclick="exportMap()" title="Export">
                    <i class="fas fa-download"></i>
                </button>
                <button class="control-btn" onclick="fullScreen()" title="Full Screen">
                    <i class="fas fa-expand"></i>
                </button>
            </div>

            <!-- Bottom Panel -->
            <div class="bottom-panel border-top bg-light">
                  <div class="d-flex justify-content-between align-items-center p-2">

                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="panelTabs">
                      <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="switchTab(this, 'orders')">
                          <i class="fas fa-list"></i> Orders
                        </a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchTab(this, 'routes')">
                          <i class="fas fa-route"></i> Routes
                        </a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchTab(this, 'timeline')">
                          <i class="fas fa-clock"></i> Timeline
                        </a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchTab(this, 'not-scheduled')">
                          <i class="fas fa-exclamation-triangle"></i> Not Scheduled
                        </a>
                      </li>
                    </ul>


                    <div class="d-flex align-items-center">
                          <button class="btn btn-primary btn-sm me-2" onclick="importOrders()">
                            <i class="fas fa-upload"></i> Import Orders
                          </button>
                          <button class="btn btn-success btn-sm me-2" onclick="optimizeRoutes()">
                            <i class="fas fa-route"></i> Plan Routes
                          </button>
                          <button class="btn btn-outline-secondary btn-sm" onclick="shareRoutes()">
                            <i class="fas fa-share"></i> Share Routes
                          </button>
                          <button class="btn btn-link ms-2" onclick="toggleBottomPanel()" title="Toggle Panel">
                            <i class="fas fa-chevron-down"></i>
                          </button>
                    </div>
                </div>

                <div id="panel-content-container" class="panel-content">
                </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Routes have been planned</span>
        <button onclick="hideNotification()" style="background: none; border: none; color: white; margin-left: 1rem;">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Optimizing routes...</div>
    </div>



    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SheetJS for Excel processing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Custom functions -->
    <script src="../backend/func.js"></script>

    <script>
        // Initialize map
        let map;
        let markers = [];
        let routes = [];
        let currentTab = 'orders';

        let allDrivers = [];
        let allCustomers = [];
        let allDepots = [];

        // Sample orders data
        const ordersData = [];

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            initMap();
            await loadAllData();
            // populateOrdersTable();
            loadAndDisplayDrivers();
            loadAndDisplayCustomers();

            switchTab(document.querySelector('.nav-link.active'), 'orders'); // Hi·ªÉn th·ªã tab Orders m·∫∑c ƒë·ªãnh

            showNotification('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i. S·∫µn s√†ng t·ªëi ∆∞u!');

            // Kh·ªüi t·∫°o c√°c event listeners cho Add Customer
            initAddCustomerEvents();
        });

        async function loadAllData() {
            try {
                // G·ª≠i 3 y√™u c·∫ßu c√πng l√∫c v√† ch·ªù t·∫•t c·∫£ ho√†n th√†nh
                const [driversRes, customersRes, depotsRes] = await Promise.all([
                    fetch('../data/drivers.json'),
                    fetch('../data/customers.json'),
                    fetch('../data/depots.json')
                ]);

                // Chuy·ªÉn ƒë·ªïi k·∫øt qu·∫£ th√†nh JSON
                allDrivers = await driversRes.json();
                allCustomers = await customersRes.json();
                allDepots = await depotsRes.json();

                console.log("T·∫•t c·∫£ d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng!");

            } catch (error) {
                console.error("L·ªói nghi√™m tr·ªçng khi t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu:", error);
                // C√≥ th·ªÉ hi·ªÉn th·ªã m·ªôt th√¥ng b√°o l·ªói l·ªõn ·ªü ƒë√¢y
            }
        }

        function initMap() {
            try {
                // Initialize Leaflet map centered on Ho Chi Minh City
                map = L.map('map').setView([10.8231, 106.6297], 12);

                // ƒê·∫£m b·∫£o window.map ƒë∆∞·ª£c g√°n ƒë√∫ng instance v√† c√≥ c√°c ph∆∞∆°ng th·ª©c c·∫ßn thi·∫øt
                window.map = map;

                // ƒê·ª£i map s·∫µn s√†ng ho√†n to√†n tr∆∞·ªõc khi s·ª≠ d·ª•ng
                setTimeout(() => {
                    if (window.map && typeof window.map.addLayer === 'function') {
                        console.log('‚úÖ Map ƒë√£ s·∫µn s√†ng v·ªõi ƒë·∫ßy ƒë·ªß ch·ª©c nƒÉng');
                    } else {
                        console.error('‚ùå Map ch∆∞a s·∫µn s√†ng sau khi kh·ªüi t·∫°o');
                    }
                }, 100);

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | <a href="https://www.mapbox.com/">MapBox Streets</a>'
                }).addTo(map);

                const depotIcon = L.icon({
                  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41],
                  popupAnchor: [1, -34],
                  shadowSize: [41, 41]
                });

                // 2Ô∏è‚É£ T·∫°o icon ri√™ng cho customer (m√†u ƒë·ªè)
                const customerIcon = L.icon({
                  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41],
                  popupAnchor: [1, -34],
                  shadowSize: [41, 41]
                });

                // 3Ô∏è‚É£ Load depot markers (m√†u xanh)
                fetch("../data/depots.json")
                  .then(response => response.json())
                  .then(data => {
                    data.forEach(depot => {
                      const marker = L.marker([depot.latitude, depot.longitude], { icon: depotIcon }).addTo(map);
                      marker.bindPopup(`<b>${depot.name}</b><br>Lat: ${depot.latitude}<br>Lon: ${depot.longitude}`);
                    });
                  })
                  .catch(error => console.error("L·ªói t·∫£i JSON depot:", error));

                // 4Ô∏è‚É£ Load customer markers (m√†u ƒë·ªè)
                fetch("../data/customers.json")
                  .then(response => response.json())
                  .then(data => {
                    data.forEach(customer => {
                      if (customer.latitude && customer.longitude) {
                        const marker = L.marker([customer.latitude, customer.longitude], { icon: customerIcon }).addTo(map);
                        marker.bindPopup(`<b>${customer.name}</b><br>ID: ${customer.id}<br>ƒê·ªãa ch·ªâ: ${customer.address}<br>SƒêT: ${customer.phone}`);
                      }
                    });
                  })
                  .catch(error => console.error("L·ªói t·∫£i JSON customer:", error));

                console.log('Map ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng:', map);

            } catch (error) {
                console.error('L·ªói khi kh·ªüi t·∫°o map:', error);
            }
        }

        // Toggle bottom panel
        function toggleBottomPanel() {
            const panel = document.querySelector('.bottom-panel');
            panel.classList.toggle('collapsed');
        }

        // Tab switching
        function switchTab(tabElement, tabName) {
            document.querySelectorAll('.panel-tab, .nav-link').forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');
            currentTab = tabName;

            // D·ª±a v√†o tab ƒë∆∞·ª£c ch·ªçn, g·ªçi h√†m t∆∞∆°ng ·ª©ng ƒë·ªÉ v·∫Ω l·∫°i n·ªôi dung
            if (tabName === 'orders') {
                populateOrdersTable();
            } else if (tabName === 'routes') {
                populateRoutesTable(); // G·ªçi h√†m m·ªõi c·ªßa ch√∫ng ta
            } else {
                // C√°c tab kh√°c t·∫°m th·ªùi hi·ªÉn th·ªã th√¥ng b√°o
                const panelContent = document.getElementById('panel-content-container');
                panelContent.innerHTML = `<div style="text-align: center; padding: 2rem; color: #6b7280;">Ch·ª©c nƒÉng ${tabName} ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.</div>`;
            }
        }

        function populateOrdersTable() {
            const panelContent = document.getElementById('panel-content-container');
            let tableHTML = `
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" onchange="selectAllOrders(this)"></th>
                            <th>Customer ID</th>
                            <th>T√™n Kh√°ch H√†ng</th>
                            <th>ƒê·ªãa Ch·ªâ</th>
                            <th>S·ªë ƒêi·ªán Tho·∫°i</th>
                            <th>Email</th>
                            <th>T·ªça ƒê·ªô (Lat, Lon)</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody">
            `;

            allCustomers.forEach(customer => {
                tableHTML += `
                    <tr>
                        <td><input type="checkbox" class="order-checkbox"></td>
                        <td><strong>${customer.id}</strong></td>
                        <td>${customer.name}</td>
                        <td>${customer.address}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.latitude || 0}, ${customer.longitude || 0}</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            panelContent.innerHTML = tableHTML;
        }

        function populateRoutesTable() {
            const panelContent = document.getElementById('panel-content-container');

            // 1. T·∫°o HTML cho s∆∞·ªùn b·∫£ng v√† ti√™u ƒë·ªÅ c·ªôt
            let tableHTML = `
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Driver ID</th>
                            <th>T√™n T√†i X·∫ø</th>
                            <th>Kho Xu·∫•t Ph√°t (ID)</th>
                            <th>ƒê·ªãa Ch·ªâ Kho</th>
                            <th>Customer ID</th>
                            <th>ƒêi·ªÉm ƒê·∫øn (Kh√°ch H√†ng)</th>
                            <th>Tuy·∫øn ƒê∆∞·ªùng (T·∫°m th·ªùi)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // 2. B·∫Øt c·∫∑p ng·∫´u nhi√™n (t·∫°m th·ªùi)
            // L·∫•y m·ªôt danh s√°ch kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c x√°o tr·ªôn
            const shuffledCustomers = [...allCustomers].sort(() => 0.5 - Math.random());

            // 3. L·∫∑p qua t·ª´ng t√†i x·∫ø ƒë·ªÉ t·∫°o m·ªôt h√†ng trong b·∫£ng
            allDrivers.forEach((driver, index) => {
                // B·∫Øt c·∫∑p t√†i x·∫ø v·ªõi m·ªôt kh√°ch h√†ng ng·∫´u nhi√™n
                const customer = shuffledCustomers[index % shuffledCustomers.length];

                // T√¨m th√¥ng tin kho c·ªßa t√†i x·∫ø d·ª±a tr√™n depot_id
                const depot = allDepots.find(d => d.id === driver.depot_id);
                const depotAddress = depot ? depot.address : "Kh√¥ng t√¨m th·∫•y kho";

                // 4. T·∫°o HTML cho h√†ng d·ªØ li·ªáu
                tableHTML += `
                    <tr>
                        <td><strong>${driver.id}</strong></td>
                        <td>${driver.name}</td>
                        <td>Kho ${driver.depot_id}</td>
                        <td>${depotAddress}</td>
                        <td><strong>${customer.id}</strong></td>
                        <td>${customer.address}</td>
                        <td><em>null</em></td>
                    </tr>
                `;
            });

            // 5. ƒê√≥ng b·∫£ng v√† g√°n v√†o giao di·ªán
            tableHTML += `</tbody></table>`;
            panelContent.innerHTML = tableHTML;
        }

        function updatePanelContent(tabName) {
            const tbody = document.getElementById('orders-tbody');

            if (tabName === 'orders') {
                populateOrdersTable();
            } else if (tabName === 'routes') {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4">Routes information will be displayed here</td></tr>';
            } else if (tabName === 'timeline') {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4">Timeline view will be displayed here</td></tr>';
            } else if (tabName === 'not-scheduled') {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4">Unscheduled orders will be displayed here</td></tr>';
            }
        }

        async function loadAndDisplayCustomers() {
            const tbody = document.getElementById('orders-tbody');
            if (!tbody) {
                console.error("L·ªói: Kh√¥ng t√¨m th·∫•y tbody v·ªõi id='orders-tbody'");
                return;
            }

            try {
                // ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n n√†y ch√≠nh x√°c (c√πng c·∫•p v·ªõi ƒë∆∞·ªùng d·∫´n depots.json)
                const response = await fetch('../data/customers.json');
                if (!response.ok) {
                    throw new Error(`L·ªói HTTP: ${response.status}`);
                }
                const customers = await response.json();

                // X√≥a d√≤ng "ƒêang t·∫£i..."
                tbody.innerHTML = '';

                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 1rem;">Kh√¥ng c√≥ d·ªØ li·ªáu kh√°ch h√†ng.</td></tr>';
                    return;
                }

                // L·∫∑p qua t·ª´ng kh√°ch h√†ng v√† t·∫°o m·ªôt h√†ng (tr) m·ªõi
                customers.forEach(customer => {
                    const row = document.createElement('tr');

                    // T·∫°o n·ªôi dung HTML cho c√°c √¥ (td)
                    row.innerHTML = `
                        <td><input type="checkbox" class="order-checkbox" value="${customer.id}"></td>
                        <td><strong>${customer.id}</strong></td>
                        <td>${customer.name}</td>
                        <td>${customer.address}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.latitude || 0}, ${customer.longitude || 0}</td>
                    `;

                    // Th√™m h√†ng m·ªõi t·∫°o v√†o trong tbody
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error("L·ªói kh√¥ng th·ªÉ t·∫£i file customers.json:", error);
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 1rem; color: red;">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu kh√°ch h√†ng.</td></tr>`;
            }
        }

        // Driver functions
        function toggleDriver(element, driverId) {
            // 1. L·∫•y checkbox b√™n trong
            const checkbox = element.querySelector('.driver-checkbox');

            // 2. Khi click v√†o div, ch√∫ng ta s·∫Ω "ƒë·∫£o" tr·∫°ng th√°i c·ªßa class 'selected'
            element.classList.toggle('selected');

            // 3. ƒê·ªìng b·ªô tr·∫°ng th√°i c·ªßa checkbox V·ªöI tr·∫°ng th√°i 'selected' c·ªßa div
            // ƒê√¢y l√† logic ƒë√∫ng: g√°n tr·∫°ng th√°i, kh√¥ng ph·∫£i "ƒë·∫£o ng∆∞·ª£c"
            checkbox.checked = element.classList.contains('selected');

            // 4. G·ªçi h√†m ƒë·∫øm s·ªë l∆∞·ª£ng t√†i x·∫ø ƒë√£ ch·ªçn
            updateSelectedDriversCount();
        }

        function updateSelectedDriversCount() {
            const selectedCount = document.querySelectorAll('.driver-checkbox:checked').length;
            const badge = document.querySelector('.badge');
            if (badge) {
                badge.textContent = `${selectedCount} drivers selected`;
            }
        }

        // Map functions
        function centerMap() {
            map.setView([10.8231, 106.6297], 12);
        }

        function zoomIn() {
            map.zoomIn();
        }

        function zoomOut() {
            map.zoomOut();
        }

        function toggleSatellite() {
            // Toggle between normal and satellite view
            const currentLayer = map._layers[Object.keys(map._layers)[0]];
            map.removeLayer(currentLayer);

            if (currentLayer._url.includes('openstreetmap')) {
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles ¬© Esri'
                }).addTo(map);
            } else {
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            }
        }

        function toggleTraffic() {
            showNotification('Traffic layer toggled');
        }

        function exportMap() {
            showNotification('Map exported successfully');
        }

        function fullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        async function optimizeRoutes() {
          showLoading();
          try {
            const response = await fetch("http://127.0.0.1:8000/api/calculate/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                num_vehicles_per_depot: 2
              })
            });

            const result = await response.json();
            hideLoading();

            if (result.status === "success") {
              showNotification("Routes optimized successfully!", "success");
              console.log("K·∫øt qu·∫£:", result);

              const routes = result.best.routes
              // C√≥ th·ªÉ render routes l√™n map ·ªü ƒë√¢y
              // ==========================
              //  X√≥a polyline c≈© (n·∫øu c√≥)
              // ==========================
              if (window.currentPolylines) {
                window.currentPolylines.forEach(line => map.removeLayer(line));
              }
              window.currentPolylines = [];

              // ==========================
              // V·∫Ω route m·ªõi
              // ==========================
              const colors = ["#e6194b", "#3cb44b", "#ffe119", "#0082c8", "#f58231", "#911eb4", "#46f0f0"];

              routes.forEach((routeObj, idx) => {

                const rawCoords = routeObj.route || routeObj.path || routeObj.coordinates;
                if (!rawCoords || rawCoords.length === 0) return;

                // Chu·∫©n h√≥a v·ªÅ [lat, lng]
                const routeCoords = rawCoords.map(p => [p.lat || p.latitude, p.lng || p.longitude]);

                // V·∫Ω polyline
                const polyline = L.polyline(routeCoords, {
                  color: colors[idx % colors.length],
                  weight: 5,
                  opacity: 0.8,
                }).addTo(map);

                // L∆∞u l·∫°i ƒë·ªÉ sau x√≥a
                window.currentPolylines.push(polyline);

                // Fit b·∫£n ƒë·ªì theo route ƒë·∫ßu ti√™n
                if (idx === 0) map.fitBounds(polyline.getBounds());

                // Th√™m marker b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c
                const start = routeCoords[0];
                const end = routeCoords[routeCoords.length - 1];

                L.marker(start).addTo(map).bindPopup(`üöö Route ${idx + 1} Start`);
                L.marker(end).addTo(map).bindPopup(`üèÅ Route ${idx + 1} End`);
              });
            } else {
              showNotification(result.message || "No solution found!", "error");
            }

          } catch (error) {
            hideLoading();
            console.error("Error:", error);
            showNotification("Error while optimizing routes!", "error");
          }
        }

        function switchView() {
            // L·∫•y danh s√°ch drivers ƒë∆∞·ª£c ch·ªçn
            const selectedDrivers = document.querySelectorAll('#driver-list-container .driver-checkbox:checked');
            if (selectedDrivers.length !== 2) {
                showNotification('Vui l√≤ng ch·ªçn ƒë√∫ng 2 drivers ƒë·ªÉ th·ª±c hi·ªán switch!', 'error');
                return;
            }

            const driverItems = [];
            selectedDrivers.forEach(checkbox => {
                const driverItem = checkbox.closest('.driver-item');
                const driverId = checkbox.id.replace('checkbox-', '');
                const driverName = driverItem.querySelector('.driver-name').textContent;
                const depotInfo = driverItem.querySelector('.driver-contact-info span:last-child').textContent;
                const depotId = depotInfo.replace('Kho: ', '');

                driverItems.push({
                    id: driverId,
                    name: driverName,
                    depotId: depotId
                });
            });

            switchDriversDepot(driverItems[0].id, driverItems[1].id);
        }
        async function switchDriversDepot(driverId1, driverId2) {
            showLoading();
            try {
                const response = await fetch("http://127.0.0.1:8000/api/switch-drivers/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        driver_id_1: driverId1,
                        driver_id_2: driverId2
                    })
                });

                const result = await response.json();
                hideLoading();

                if (result.status === "success") {
                    showNotification(`ƒê√£ ho√°n ƒë·ªïi depot th√†nh c√¥ng! Driver ${driverId1} ‚Üî Driver ${driverId2}`, "success");
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification(result.message || "Kh√¥ng th·ªÉ th·ª±c hi·ªán switch!", "error");
                }

            } catch (error) {
                hideLoading();
                console.error("Error:", error);
                showNotification("L·ªói k·∫øt n·ªëi ƒë·∫øn server!", "error");
            }
        }

        function reverseRoutes() {
            showNotification('Routes reversed');
        }

        async function copyRoutes() {
            const selectedDrivers = document.querySelectorAll('#driver-list-container .driver-checkbox:checked');
            if (selectedDrivers.length === 0) {
                showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 driver ƒë·ªÉ copy!', 'error');
                return;
            }

            try {
                const routesData = [];
                selectedDrivers.forEach(checkbox => {
                    const driverItem = checkbox.closest('.driver-item');
                    const driverId = checkbox.id.replace('checkbox-', '');
                    const driverName = driverItem.querySelector('.driver-name').textContent;
                    const depotInfo = driverItem.querySelector('.driver-contact-info span:last-child').textContent;
                    const depotId = depotInfo.replace('Kho: ', '');

                    // T√¨m th√¥ng tin driver t·ª´ allDrivers array
                    const driverData = allDrivers.find(d => d.id === driverId);
                    const depotData = allDepots.find(d => d.id === depotId);

                    routesData.push({
                        driverId: driverId,
                        driverName: driverName,
                        depotId: depotId,
                        depotAddress: depotData ? depotData.address : 'Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ',
                        phone: driverData ? driverData.phone : 'N/A'
                    });
                });
                let copyText = `=== DANH S√ÅCH TUY·∫æN ƒê∆Ø·ªúNG (${routesData.length} DRIVERS) ===\n`;
                copyText += `Th·ªùi gian xu·∫•t: ${new Date().toLocaleString('vi-VN')}\n\n`;

                routesData.forEach((route, index) => {
                    copyText += `${index + 1}. DRIVER ${route.driverId}\n`;
                    copyText += `   T√™n: ${route.driverName}\n`;
                    copyText += `   SƒêT: ${route.phone}\n`;
                    copyText += `   Kho xu·∫•t ph√°t: ${route.depotId}\n`;
                    copyText += `   ƒê·ªãa ch·ªâ kho: ${route.depotAddress}\n`;
                    copyText += `   Tr·∫°ng th√°i: Unassigned\n`;
                    copyText += `   Tuy·∫øn ƒë∆∞·ªùng: Ch∆∞a c√≥ d·ªØ li·ªáu tuy·∫øn ƒë∆∞·ªùng c·ª• th·ªÉ\n\n`;
                });

                copyText += `=== T·ªîNG K·∫æT ===\n`;
                copyText += `T·ªïng s·ªë drivers: ${routesData.length}\n`;
                copyText += `ƒê√£ copy l√∫c: ${new Date().toLocaleString('vi-VN')}\n`;

                // Copy v√†o clipboard
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(copyText);
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = copyText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();

                    try {
                        document.execCommand('copy');
                    } catch (err) {
                        console.error('Fallback: Kh√¥ng th·ªÉ copy', err);
                        showNotification('Kh√¥ng th·ªÉ copy v√†o clipboard!', 'error');
                        return;
                    }

                    textArea.remove();
                }
                showNotification(`ƒê√£ copy tuy·∫øn ƒë∆∞·ªùng c·ªßa ${routesData.length} drivers v√†o clipboard!`, 'success');
            } catch (error) {
                console.error('L·ªói khi copy routes:', error);
                showNotification('C√≥ l·ªói x·∫£y ra khi copy!', 'error');
            }
        }

        function hideDrivers() {
            const driversSection = document.querySelector('.drivers-section');
            driversSection.style.display = driversSection.style.display === 'none' ? 'block' : 'none';
        }

        function importOrders() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Ki·ªÉm tra ƒë·ªãnh d·∫°ng file
                    if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                        showNotification('Ch·ªâ ch·∫•p nh·∫≠n file Excel (.xlsx ho·∫∑c .xls)!', 'error');
                        return;
                    }

                    showNotification(`ƒêang x·ª≠ l√Ω file ${file.name}...`);
                    setTimeout(() => {
                        showNotification('Orders imported successfully!', 'success');
                    }, 2000);
                }
            };
            input.click();
        }

        function planRoutes() {
            showLoading();

            setTimeout(() => {
                hideLoading();
                showNotification('Routes planned successfully!', 'success');
            }, 2500);
        }

        function shareRoutes() {
            if (navigator.share) {
                navigator.share({
                    title: 'Route Optimization Results',
                    text: 'Check out these optimized routes!',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                showNotification('Link copied to clipboard!');
            }
        }

        function selectAllOrders(checkbox) {
            const orderCheckboxes = document.querySelectorAll('.order-checkbox');
            orderCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function viewOrderDetails(orderIndex) {
            const order = ordersData[orderIndex];
            alert(`Order Details:\n\nID: ${order.id}\nLocation: ${order.location}\nAddress: ${order.address}\nPriority: ${order.priority}\nWeight: ${order.weight}kg\nVolume: ${order.volume}m¬≥\nDuration: ${order.duration}`);
        }

        function showNotification(message, type = 'default') {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notification-text');

            text.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'flex';

            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            document.getElementById('notification').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        async function loadAndDisplayDrivers() {
            const driverListContainer = document.getElementById('driver-list-container');

            if (!driverListContainer) {
                console.error("L·ªói: Kh√¥ng t√¨m th·∫•y th·∫ª div v·ªõi id='driver-list-container'.");
                return;
            }

            try {
                const response = await fetch('/data/drivers.json');
                if (!response.ok) {
                    throw new Error(`L·ªói HTTP: ${response.status}`);
                }
                const drivers = await response.json();
                driverListContainer.innerHTML = '';

                if (drivers.length === 0) {
                    driverListContainer.innerHTML = '<p style="color: #6b7280; padding: 0.75rem;">Kh√¥ng c√≥ d·ªØ li·ªáu t√†i x·∫ø.</p>';
                    return;
                }
                const colors = ['#ef4444', '#f97316', '#22c55e', '#0bd2f5', '#6b7280'];
                drivers.forEach((driver, index) => {
                    // Validate d·ªØ li·ªáu driver
                    if (!driver.id || !driver.name || !driver.phone || !driver.depot_id) {
                        console.warn(`D·ªØ li·ªáu driver kh√¥ng ƒë·∫ßy ƒë·ªß:`, driver);
                        return;
                    }
                    const color = colors[index % colors.length];
                    const driverItem = document.createElement('div');
                    driverItem.className = 'driver-item';
                    driverItem.id = `driver-${driver.id}`;
                    driverItem.onclick = function() {
                        toggleDriver(driverItem, driver.id);
                    };

                    driverItem.innerHTML = `
                        <input type="checkbox" class="driver-checkbox" id="checkbox-${driver.id}">
                        <div class="driver-color" style="background-color: ${color};"></div>
                        <div class="driver-info">
                            <div class="driver-name">${driver.name} (ID: ${driver.id})</div>
                            <div class="driver-contact-info">
                                <span><i class="fas fa-phone-alt"></i> ${driver.phone}</span>
                                <span><i class="fas fa-warehouse"></i> Kho: ${driver.depot_id}</span>
                            </div>
                            <div class="driver-stats">
                                <span class="text-muted">Unassigned</span>
                            </div>
                        </div>
                    `;
                    driverListContainer.appendChild(driverItem);
                });

                console.log(`ƒê√£ t·∫£i th√†nh c√¥ng ${drivers.length} t√†i x·∫ø`);

            } catch (error) {
                console.error("L·ªói kh√¥ng th·ªÉ t·∫£i file drivers.json:", error);
                driverListContainer.innerHTML = '<p style="color: red; padding: 0.75rem;">Kh√¥ng th·ªÉ t·∫£i danh s√°ch t√†i x·∫ø.</p>';
            }
        }

        function updateSelectedDriversCount() {
            const selectedCount = document.querySelectorAll('#driver-list-container .driver-checkbox:checked').length;
            const driverCountBadge = document.getElementById('driver-count-badge');
            if (driverCountBadge) {
                driverCountBadge.textContent = `${selectedCount} drivers selected`;
            }
        }
        window.addEventListener('resize', function() {
            if (map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        });
    </script>
</body>
</html>